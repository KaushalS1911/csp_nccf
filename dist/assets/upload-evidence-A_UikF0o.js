import{aF as ee,a as te,r as n,u as ae,K as y,f as se,o as oe,M as l,j as e,H as ne,q as ce,S as P,B as p,E as U,cG as T,cH as E,cI as re,cd as L,v as ie,T as g,cJ as le,D as de,C as pe,n as me,cK as he,cL as ue,d as xe,e as ge,cM as j,cN as fe,p as ye}from"./index-Dq0zltwJ.js";const je=xe().shape({doc_type:ge().required("Document type is required")});function we(){var k;const M=ee(),v=te(),[I,R]=n.useState(""),{vendor:s}=ae(),[r,b]=n.useState([]),[d,_]=n.useState([]),[W,D]=n.useState(!1),[f,$]=n.useState([]),[S,C]=n.useState([]),[be,B]=n.useState([]),[H,z]=n.useState([]),O=n.useMemo(()=>({doc_type:"",csp_code:""}),[]);n.useEffect(()=>{s&&y.get(`http://ec2-54-173-125-80.compute-1.amazonaws.com:8080//nccf/branch/${s==null?void 0:s.branch}/csp/list`).then(t=>{var a;return z((a=t==null?void 0:t.data)==null?void 0:a.data)}).catch(t=>console.log(t)),q()},[s==null?void 0:s.csp_code]);function q(){s!=null&&s.csp_code&&y.get(`http://ec2-54-173-125-80.compute-1.amazonaws.com:8080/nccf/csp/${s==null?void 0:s.csp_code}/documents`).then(t=>{var a;return $((a=t==null?void 0:t.data)==null?void 0:a.data)}).catch(t=>console.error(t))}const w=se({defaultValues:O,resolver:oe(je)}),{handleSubmit:V,control:A,setValue:_e,watch:G}=w,K=G("doc_type"),F=V(async t=>{var m;if(!((m=r[0])!=null&&m.preview))return l("Please Select Image",{variant:"error"}),!1;const a={type:t.doc_type,image:r[0],id:Date.now()};_(i=>[...i,a]),b([]);const o=new FormData;o.append("doc_type",t.doc_type),o.append("csp_code",s);for(let i of r)try{o.append("file",i)}catch(u){console.error("Error compressing file:",u),o.append("file",i)}}),J=[{label:"Milling Unit Photo",key:"milling_unit_photo"},{label:"Milling Unit Video",key:"milling_unit_video"}];n.useEffect(()=>{var t;(t=r[0])!=null&&t.preview&&F()},[r]);const N=n.useCallback(t=>{b([...r,...t.map(a=>Object.assign(a,{preview:URL.createObjectURL(a)}))])},[r]),Y=async t=>{var m,i,u;const a=f==null?void 0:f.filter(h=>h.doc_type===I);if(a.length>=5){l(e.jsxs(p,{sx:{p:"5px"},children:[e.jsx(g,{variant:"subtitle1",style:{fontWeight:"bold"},children:` ${j((m=a[0])==null?void 0:m.doc_type)} upload limit exceed`}),e.jsx(g,{variant:"body2",children:`If you want to upload more document of ${j((i=a[0])==null?void 0:i.doc_type)}, then remove existing ${j((u=a[0])==null?void 0:u.doc_type)} document.`})]}),{variant:"error",autoHideDuration:3e3});return}D(!0);const o={maxSizeMB:.5,maxWidthOrHeight:1200,useWebWorker:!0};try{const h=await Promise.all(t.map(async c=>{const x=new FormData,Se=await fe(c==null?void 0:c.image,o);return x.append("file",c==null?void 0:c.image),x.append("doc_type",c==null?void 0:c.type),x.append("csp_code",s==null?void 0:s.csp_code),x}));await Promise.all(h.map(c=>y.post("http://ec2-54-173-125-80.compute-1.amazonaws.com:8080/nccf/csp/upload_document",c,{headers:{"Content-Type":"multipart/form-data"}})))?(l("Your Document Uploaded"),v.push(ye.dashboard.document.document_list),C([])):l("Failed to Upload",{variant:"error"})}catch(h){console.error("Error submitting form:",h),l("Failed to Upload",{variant:"error"})}finally{D(!1)}},Q=n.useCallback(t=>{const a=d.filter(o=>o.id!==t);l("Delete success!"),_(a)},[l,d]);n.useRef(null);const X=n.useCallback(t=>{B(t.target.value),C(t.target.value)},[S]),Z=e.jsxs(e.Fragment,{children:[e.jsx(ne,{children:e.jsx("title",{children:"Dashboard | Upload Evidence"})}),e.jsx(ce,{children:e.jsx(P,{spacing:3,sx:{p:3},children:e.jsxs(P,{children:[e.jsxs(p,{rowGap:3,columnGap:2,display:"grid",gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(2, 1fr)"},children:[(s==null?void 0:s.category)==="branch"&&e.jsxs(U,{sx:{flexShrink:0},children:[e.jsx(T,{children:"CSP"}),e.jsx(E,{value:S,onChange:X,input:e.jsx(re,{label:"Type"}),MenuProps:{PaperProps:{sx:{maxHeight:240}}},children:H.map(t=>e.jsx(L,{value:t.csp_code,children:t.name},t.csp_code))})]}),e.jsx(ie,{name:"doc_type",control:A,render:({field:t,fieldState:a})=>e.jsxs(U,{fullWidth:!0,error:!!a.error,children:[e.jsx(T,{children:"Document Type"}),e.jsx(E,{...t,label:"Document Type",disabled:d.length>=5,onChange:o=>{t.onChange(o),R(o.target.value)},children:J.map(o=>e.jsx(L,{value:o.key,children:o.label},o.key))}),a.error&&e.jsx(g,{variant:"caption",color:"error",children:a.error.message})]})})]}),e.jsxs(p,{sx:{position:"relative"},children:[e.jsx(le,{sx:{height:"100px",width:"100px",position:"absolute",right:"0%",zIndex:"200",opacity:"0"},accept:K==="milling_unit_photo"?{"image/jpeg":[],"image/jpg":[],"image/png":[]}:{"video/mp4":[],"video/avi":[],"video/mkv":[],"video/mov":[]},disabled:d.length>=5,multiple:!0,onDrop:N}),e.jsx(p,{sx:{display:"flex",justifyContent:"flex-end",mt:"20px"},children:e.jsx(de,{style:{cursor:"pointer",maxWidth:"200px"},variant:"contained",children:"Choose File"})})]})]})})})]});return e.jsx(e.Fragment,{children:e.jsx(pe,{maxWidth:M.themeStretch?!1:"xl",children:W?e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"80vh"},children:e.jsx(me,{sx:{margin:"auto"}})}):e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"h4",children:"Upload Evidence"}),e.jsxs(p,{sx:{mt:5,width:1,height:320,borderRadius:2},children:[e.jsx(he,{methods:w,onSubmit:F,children:Z}),((k=d[0])==null?void 0:k.type)&&e.jsx(ue,{data:d,handleDeleteRow:Q,handleAllSubmit:Y})]})]})})})}export{we as default};
