import{aF as A,a as G,r as n,u as K,K as S,f as J,o as Y,M as l,j as e,H as N,q as Q,S as F,B as p,v as X,E as Z,cF as ee,cG as te,cd as se,T as g,cH as ae,D as oe,C as ne,n as re,cI as ce,cJ as ie,d as le,e as de,cK as y,cL as pe,p as me}from"./index-lGI9Vm0B.js";const ue=le().shape({doc_type:de().required("Document type is required")});function fe(){var C;const v=A(),U=G(),[k,E]=n.useState(""),{vendor:o}=K(),[c,j]=n.useState([]),[d,_]=n.useState([]),[L,b]=n.useState(!1),[f,T]=n.useState([]),R=n.useMemo(()=>({doc_type:"",csp_code:""}),[]);n.useEffect(()=>{I()},[o==null?void 0:o.csp_code]);function I(){o!=null&&o.csp_code&&S.get(`http://ec2-54-173-125-80.compute-1.amazonaws.com:8080/nccf/csp/${o==null?void 0:o.csp_code}/documents`).then(t=>{var s;return T((s=t==null?void 0:t.data)==null?void 0:s.data)}).catch(t=>console.error(t))}const D=J({defaultValues:R,resolver:Y(ue)}),{handleSubmit:M,control:W,setValue:he,watch:$}=D,H=$("doc_type"),w=M(async t=>{var m;if(!((m=c[0])!=null&&m.preview))return l("Please Select Image",{variant:"error"}),!1;const s={type:t.doc_type,image:c[0],id:Date.now()};_(i=>[...i,s]),j([]);const a=new FormData;a.append("doc_type",t.doc_type),a.append("csp_code",o);for(let i of c)try{a.append("file",i)}catch(h){console.error("Error compressing file:",h),a.append("file",i)}}),P=[{label:"Milling Unit Photo",key:"milling_unit_photo"},{label:"Milling Unit Video",key:"milling_unit_video"}];n.useEffect(()=>{var t;(t=c[0])!=null&&t.preview&&w()},[c]);const q=n.useCallback(t=>{j([...c,...t.map(s=>Object.assign(s,{preview:URL.createObjectURL(s)}))])},[c]),z=async t=>{var m,i,h;const s=f==null?void 0:f.filter(u=>u.doc_type===k);if(s.length>=5){l(e.jsxs(p,{sx:{p:"5px"},children:[e.jsx(g,{variant:"subtitle1",style:{fontWeight:"bold"},children:` ${y((m=s[0])==null?void 0:m.doc_type)} upload limit exceed`}),e.jsx(g,{variant:"body2",children:`If you want to upload more document of ${y((i=s[0])==null?void 0:i.doc_type)}, then remove existing ${y((h=s[0])==null?void 0:h.doc_type)} document.`})]}),{variant:"error",autoHideDuration:3e3});return}b(!0);const a={maxSizeMB:.5,maxWidthOrHeight:1200,useWebWorker:!0};try{const u=await Promise.all(t.map(async r=>{const x=new FormData,V=await pe(r==null?void 0:r.image,a);return x.append("file",V),x.append("doc_type",r==null?void 0:r.type),x.append("csp_code",o==null?void 0:o.csp_code),x}));await Promise.all(u.map(r=>S.post("http://ec2-54-173-125-80.compute-1.amazonaws.com:8080/nccf/csp/upload_document",r,{headers:{"Content-Type":"multipart/form-data"}})))?(l("Your Document Uploaded"),U.push(me.dashboard.document.document_list)):l("Failed to Upload",{variant:"error"})}catch(u){console.error("Error submitting form:",u),l("Failed to Upload",{variant:"error"})}finally{b(!1)}},B=n.useCallback(t=>{const s=d.filter(a=>a.id!==t);l("Delete success!"),_(s)},[l,d]);n.useRef(null);const O=e.jsxs(e.Fragment,{children:[e.jsx(N,{children:e.jsx("title",{children:"Dashboard | Upload Evidence"})}),e.jsx(Q,{children:e.jsx(F,{spacing:3,sx:{p:3},children:e.jsxs(F,{children:[e.jsx(p,{rowGap:3,columnGap:2,display:"grid",gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(2, 1fr)"},children:e.jsx(X,{name:"doc_type",control:W,render:({field:t,fieldState:s})=>e.jsxs(Z,{fullWidth:!0,error:!!s.error,children:[e.jsx(ee,{children:"Document Type"}),e.jsx(te,{...t,label:"Document Type",disabled:d.length>=5,onChange:a=>{t.onChange(a),E(a.target.value)},children:P.map(a=>e.jsx(se,{value:a.key,children:a.label},a.key))}),s.error&&e.jsx(g,{variant:"caption",color:"error",children:s.error.message})]})})}),e.jsxs(p,{sx:{position:"relative"},children:[e.jsx(ae,{sx:{height:"100px",width:"100px",position:"absolute",right:"0%",zIndex:"200",opacity:"0"},accept:H==="milling_unit_photo"?{"image/jpeg":[],"image/jpg":[],"image/png":[]}:{"video/mp4":[],"video/avi":[],"video/mkv":[],"video/mov":[]},disabled:d.length>=5,multiple:!0,onDrop:q}),e.jsx(p,{sx:{display:"flex",justifyContent:"flex-end",mt:"20px"},children:e.jsx(oe,{style:{cursor:"pointer",maxWidth:"200px"},variant:"contained",children:"Choose File"})})]})]})})})]});return e.jsx(e.Fragment,{children:e.jsx(ne,{maxWidth:v.themeStretch?!1:"xl",children:L?e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"80vh"},children:e.jsx(re,{sx:{margin:"auto"}})}):e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"h4",children:"Upload Evidence"}),e.jsxs(p,{sx:{mt:5,width:1,height:320,borderRadius:2},children:[e.jsx(ce,{methods:D,onSubmit:w,children:O}),((C=d[0])==null?void 0:C.type)&&e.jsx(ie,{data:d,handleDeleteRow:B,handleAllSubmit:z})]})]})})})}export{fe as default};
